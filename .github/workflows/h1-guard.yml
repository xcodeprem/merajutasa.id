name: H1 Guard & KPI

on:
  push:
    
    param($m)
    $inside = $m.Groups[1].Value + 'main' + $m.Groups[2].Value
    if ($inside -notmatch 'master') { return 'branches: [' + ($inside.Trim().TrimEnd(',')) + ', master]' }
    return $m.Value
  
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: h1-guard-${{ github.ref }}
  cancel-in-progress: true

jobs:
  h1-guard:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run A8 (no-silent-drift) Gates
        uses: ./.github/actions/run-a8
        with:
          policy-path: "tools/policy/policy.json"

      - name: Run H1 Guard
        run: |
          node tools/h1-verify-guard.js
        env:
          PERF_ADVISORY: "true"
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          PR_HEAD_REF: ${{ github.head_ref || '' }}

      - name: Terminology Adoption Enforcement
        run: |
          ADOPTION_MIN=80 BANNED_MAX=0 node tools/terminology-adoption.js

      - name: Perf Smoke (advisory)
        continue-on-error: true
        run: |
          node tools/perf-budget-smoke.js || true

      - name: A11y Smoke (advisory here; strict covered in H1 Guard)
        continue-on-error: true
        run: |
          node tools/a11y-smoke.js || true

      - name: Rebuild KPI Summary (include adoption)
        run: |
          node tools/generate-h1-kpi-summary.js
          node tools/monthly-feedback-rollup.js

      - name: UI Smoke Test (Equity)
        run: |
          node tools/tests/equity-ui-smoke.test.js

      - name: Upload KPI & Equity Artifacts
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: h1-kpi
          path: |
            artifacts/h1-kpi-summary.json
            artifacts/equity-summary.json
            artifacts/equity-anomalies.json
            artifacts/under-served.json
            artifacts/feedback-monthly-rollup.json

      - name: Chain Integrity Monitor (advisory)
        run: |
          node tools/chain-monitor.js || echo "chain-monitor failed (advisory)"

      - name: Upload Chain Monitor Artifact
        if: always()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: chain-monitor
          path: artifacts/chain-monitor.json
