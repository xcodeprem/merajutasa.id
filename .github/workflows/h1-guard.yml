name: H1 Guard & KPI

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  h1-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: |
          npm ci || npm i --no-audit --no-fund
      - name: Ensure yaml present (safety net)
        run: |
          npm ls yaml || npm i yaml@^2.4.5 --no-audit --no-fund

      - name: Run A8 (no-silent-drift) aggregator
        run: node tools/no-silent-drift.js

      - name: Run H1 Guard
        run: |
          node tools/h1-verify-guard.js
        env:
          PERF_ADVISORY: 'true'
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          PR_HEAD_REF: ${{ github.head_ref || '' }}

      - name: Terminology Adoption Enforcement
        run: |
          ADOPTION_MIN=80 BANNED_MAX=0 node tools/terminology-adoption.js

      - name: Perf Smoke (advisory)
        continue-on-error: true
        run: |
          node tools/perf-budget-smoke.js || true

      - name: A11y Smoke (advisory here; strict covered in H1 Guard)
        continue-on-error: true
        run: |
          node tools/a11y-smoke.js || true

      - name: Rebuild KPI Summary (include adoption)
        run: |
          node tools/generate-h1-kpi-summary.js
          node tools/monthly-feedback-rollup.js

      - name: UI Smoke Test (Equity)
        run: |
          node tools/tests/equity-ui-smoke.test.js

      - name: Upload KPI & Equity Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: h1-kpi
          path: |
            artifacts/h1-kpi-summary.json
            artifacts/equity-summary.json
            artifacts/equity-anomalies.json
            artifacts/under-served.json
            artifacts/feedback-monthly-rollup.json

      - name: Chain Integrity Monitor (advisory)
        run: |
          node tools/chain-monitor.js || echo "chain-monitor failed (advisory)"

      - name: Upload Chain Monitor Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chain-monitor
          path: artifacts/chain-monitor.json
